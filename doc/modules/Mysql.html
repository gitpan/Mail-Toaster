<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Mail::Toaster::Mysql</title>
<link rev="made" href="mailto:matt@g5.simerson.net" />
</head>

<body style="background-color: white">

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#methods">METHODS</a></li>
	<ul>

		<li><a href="#new">new</a></li>
		<li><a href="#autocommit">autocommit</a></li>
		<li><a href="#backup">backup</a></li>
		<li><a href="#connect">connect</a></li>
		<li><a href="#db_vars">db_vars</a></li>
		<li><a href="#flush_logs">flush_logs</a></li>
		<li><a href="#get_hashes">get_hashes</a></li>
		<li><a href="#install">install</a></li>
		<li><a href="#is_newer">is_newer</a></li>
		<li><a href="#parse_dot_file">parse_dot_file</a></li>
		<li><a href="#phpmyadmin_install">phpmyadmin_install</a></li>
		<li><a href="#query">query</a></li>
		<li><a href="#query_confirm">query_confirm</a></li>
		<li><a href="#sanity">sanity</a></li>
		<li><a href="#shutdown_mysqld">shutdown_mysqld</a></li>
		<li><a href="#status">status</a></li>
		<li><a href="#tables_lock">tables_lock</a></li>
		<li><a href="#tables_unlock">tables_unlock</a></li>
		<li><a href="#version">version</a></li>
	</ul>

	<li><a href="#dependencies">Dependencies</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#bugs">BUGS</a></li>
	<li><a href="#todo">TODO</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
</ul>
<!-- INDEX END -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Mail::Toaster::Mysql</p>
<p>head1 SYNOPSIS</p>
<p>frequently used functions for Mysql.</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>I find myself using MySQL for a lot of things. Geographically distributed dns systems (MySQL replication), mail servers, and all the other fun stuff you'd use a RDBMS for. As such, I've got a growing pile of scripts that have lots of duplicated code in them. As such, the need for this Perl module grew.</p>
<pre>
       Currently used in:
  mysql_replicate_manager v1.5+
  uron.net user_*.pl
  polls.pl
  nt_export_djb_update.pl
  toaster_setup.pl</pre>
<p>
</p>
<hr />
<h1><a name="methods">METHODS</a></h1>
<p>
</p>
<h2><a name="new">new</a></h2>
<pre>
        use Mail::Toaster::Mysql;
        my $mysql = Mail::Toaster::Mysql-&gt;new();</pre>
<p>
</p>
<h2><a name="autocommit">autocommit</a></h2>
<p>
</p>
<h2><a name="backup">backup</a></h2>
<p>Back up your mysql databases</p>
<pre>
   $mysql-&gt;backup();</pre>
<p>The default location for backups is /var/backups/mysql. If you want them stored elsewhere configure then set backupdir = /path/to/backups in  your .my.cnf (as shown in the FAQ) or pass it via -d on the command line.</p>
<p>You will need to have cronolog, gzip, and mysqldump installed in a ``normal'' location. Your backups will be stored in a directory based on the date, such as /var/backups/mysql/2003/09/11/mysql_full_dump.gz. Make sure that path is configured to be backed up by your backup software.</p>
<p>
</p>
<h2><a name="connect">connect</a></h2>
<pre>
    my ($dbh, $dsn, $drh) = $mysql-&gt;connect($dot, $warn, $debug);</pre>
<p>$dot is a hashref of key/value pairs in the same format you'd find in ~/.my.cnf. Not coincidentally, that's where it expects you'll be getting them from.</p>
<p>$warn allows you to determine whether to die or warn on failure or error. To warn, set $warn to a non-zero value.</p>
<p>$debug will print out helpful debugging messages should you be having problems.</p>
<p>
</p>
<h2><a name="db_vars">db_vars</a></h2>
<p>This sub is called internally by $mysql-&gt;connect and is used principally to set some reasonable defaults should you not pass along enough connection parameters in $dot.</p>
<p>
</p>
<h2><a name="flush_logs">flush_logs</a></h2>
<pre>
        $mysql-&gt;flush_logs($dbh, $debug)</pre>
<p>runs the mysql ``FLUSH LOGS'' query on the server. This commits any pending (memory cached writes) to disk.</p>
<p>
</p>
<h2><a name="get_hashes">get_hashes</a></h2>
<p>Gets results from a mysql query as an array of hashes</p>
<pre>
   my @r = $mysql-&gt;get_hashes($dbh, $sql);</pre>
<p>$dbh is a database handle</p>
<p>$sql is query</p>
<p>
</p>
<h2><a name="install">install</a></h2>
<p>Installs MySQL</p>
<p>
</p>
<h2><a name="is_newer">is_newer</a></h2>
<pre>
        my $ver   = $mysql-&gt;version($dbh);
        my $newer = $mysql-&gt;is_newer(&quot;4.1.0&quot;, $ver);</pre>
<p>if ($newer) { print ``you are brave!'' };</p>
<p>As you can see, is_newer can be very useful, especially when you need to execute queries with syntax differences between versions of Mysql.</p>
<p>
</p>
<h2><a name="parse_dot_file">parse_dot_file</a></h2>
<pre>
 $mysql-&gt;parse_dot_file ($file, $start, $debug)</pre>
<p>Example:</p>
<pre>
 my $dot = $mysql-&gt;parse_dot_file(&quot;.my.cnf&quot;, &quot;[mysql_replicate_manager]&quot;, 0);</pre>
<pre>
 $file is the file to be parsed.</pre>
<p>$start is the [identifier] where we begin looking for settings.  This expects the format used in .my.cnf MySQL configuration files.</p>
<p>A hashref is returned wih key value pairs</p>
<p>
</p>
<h2><a name="phpmyadmin_install">phpmyadmin_install</a></h2>
<p>Install PhpMyAdmin from FreeBSD ports.</p>
<pre>
        $mysql-&gt;phpmyadmin_install($conf);</pre>
<p>$conf is a hash of configuration values. See toaster-watcher.conf for configuring the optional values to pass along.</p>
<p>
</p>
<h2><a name="query">query</a></h2>
<pre>
    my $sth = $mysql-&gt;query ($dbh, $query, $warn)</pre>
<p>$dbh is the database handle you've already acquired via $mysql-&gt;connect.</p>
<p>$query is the SQL statement to execute.</p>
<p>If $warn is set, we don't die if the query fails. This way you can decide when you call the sub whether you want it to die or return a failed $sth (and likely an error message).</p>
<pre>
 execute performs whats necessary to execute a statement
 Always returns true regardless of # of rows affected.
 For non-Select, returns # of rows affected: No rows = 0E0
 For Select, simply starts query. Follow with fetch_*</pre>
<p>
</p>
<h2><a name="query_confirm">query_confirm</a></h2>
<pre>
        $mysql-&gt;query_confirm($dbh, $query, $debug);</pre>
<p>Use this if you want to interactively get user confirmation before executing a query.</p>
<p>
</p>
<h2><a name="sanity">sanity</a></h2>
<p>A place to do validation tests on values to make sure they're reasonable</p>
<p>Currently we only check to assure the password is less than 32 characters and the username is less than 16. Many more tests will come.</p>
<p>
</p>
<h2><a name="shutdown_mysqld">shutdown_mysqld</a></h2>
<p>Shuts down mysql using a $drh handle.</p>
<pre>
   my $rc = $mysql-&gt;shutdown_mysqld($dbvs, $drh);</pre>
<p>$dbvs is a hashref containing: host, user, pass</p>
<p>returns error_code 200 on success, 500 on error. See error_desc for details.</p>
<p>
</p>
<h2><a name="status">status</a></h2>
<p>
</p>
<h2><a name="tables_lock">tables_lock</a></h2>
<pre>
        my $sth = $mysql-&gt;tables_lock($dbh, $debug);
        # do some mysql stuff
        $mysql-&gt;tables_unlock($dbh, $sth);</pre>
<p>Takes a statement handle and does a global lock on all tables.  Quite useful when you want do do things like make a tarball of the database directory, back up the server, etc.</p>
<p>
</p>
<h2><a name="tables_unlock">tables_unlock</a></h2>
<pre>
        $mysql-&gt;tables_unlock($dbh, $sth, $debug);</pre>
<p>Takes a statement handle and does a global unlock on all tables.  Quite useful after you've used $mysql-&gt;tables_lock, done your deeds and wish to release your lock.</p>
<p>
</p>
<h2><a name="version">version</a></h2>
<pre>

        my $ver = $mysql-&gt;version($dbh);</pre>
<p>Returns a string representing the version of MySQL running.</p>
<p>
</p>
<hr />
<h1><a name="dependencies">Dependencies</a></h1>
<pre>
   DBI.pm     - /usr/ports/databases/p5-DBI
   DBD::mysql - /usr/ports/databases/p5-DBD-mysql</pre>
<p>In order to use this module, you must have DBI.pm and DBD::Mysql installed. If they are not installed and you attempt to use this module, you should get some helpful error messages telling you how to install them.</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Matt Simerson &lt;<a href="mailto:matt@tnpi.biz">matt@tnpi.biz</a>&gt;</p>
<p>
</p>
<hr />
<h1><a name="bugs">BUGS</a></h1>
<p>None known. Report any to author.</p>
<p>
</p>
<hr />
<h1><a name="todo">TODO</a></h1>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>The following are all man/perldoc pages:</p>
<pre>
 Mail::Toaster 
 Mail::Toaster::Conf
 toaster.conf
 toaster-watcher.conf</pre>
<pre>
 <a href="http://matt.simerson.net/computing/mail/toaster/">http://matt.simerson.net/computing/mail/toaster/</a></pre>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>Copyright (c) 2003-2005, The Network People, Inc. All Rights Reserved.</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</p>
<p>Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</p>
<p>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</p>
<p>Neither the name of the The Network People, Inc. nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</p>
<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

</p>

</body>

</html>
