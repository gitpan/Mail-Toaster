<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Mail::Toaster::Utility</title>
<link rev="made" href="mailto:matt@g5e.simerson.net" />
</head>

<body style="background-color: white">

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#methods">METHODS</a></li>
	<ul>

		<li><a href="#new">new</a></li>
		<li><a href="#answer">answer</a></li>
		<li><a href="#archive_expand">archive_expand</a></li>
		<li><a href="#chdir_source_dir">chdir_source_dir</a></li>
		<li><a href="#check_homedir_ownership">check_homedir_ownership</a></li>
		<li><a href="#clean_tmp_dir">clean_tmp_dir</a></li>
		<li><a href="#drives_get_mounted">drives_get_mounted</a></li>
		<li><a href="#install_from_sources_php">install_from_sources_php</a></li>
		<li><a href="#file_append">file_append</a></li>
		<li><a href="#file_archive">file_archive</a></li>
		<li><a href="#file_check_readable">file_check_readable</a></li>
		<li><a href="#file_check_writable">file_check_writable</a></li>
		<li><a href="#file_delete">file_delete</a></li>
		<li><a href="#file_get">file_get</a></li>
		<li><a href="#file_read">file_read</a></li>
		<li><a href="#file_write">file_write</a></li>
		<li><a href="#files_diff">files_diff</a></li>
		<li><a href="#find_the_bin">find_the_bin</a></li>
		<li><a href="#fstab_list">fstab_list</a></li>
		<li><a href="#get_dir_files">get_dir_files</a></li>
		<li><a href="#get_the_date">get_the_date</a></li>
		<li><a href="#install_from_source">install_from_source</a></li>
		<li><a href="#is_arrayref">is_arrayref</a></li>
		<li><a href="#is_hashref">is_hashref</a></li>
		<li><a href="#is_process_running">is_process_running</a></li>
		<li><a href="#logfile_append">logfile_append</a></li>
		<li><a href="#mailtoaster">mailtoaster</a></li>
		<li><a href="#path_parse">path_parse</a></li>
		<li><a href="#parse_config">parse_config</a></li>
		<li><a href="#pidfile_check">pidfile_check</a></li>
		<li><a href="#source_warning">source_warning</a></li>
		<li><a href="#sudo">sudo</a></li>
		<li><a href="#syscmd">syscmd</a></li>
		<li><a href="#yes_or_no">yes_or_no</a></li>
	</ul>

	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#bugs">BUGS</a></li>
	<li><a href="#todo">TODO</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
</ul>
<!-- INDEX END -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Mail::Toaster::Utility</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>a group of frequently used perl methods I've written for use with various scripts.</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>useful subs that I use in scripts all over the place. Peruse through the list of methods and surely you too can find something of use.</p>
<p>
</p>
<hr />
<h1><a name="methods">METHODS</a></h1>
<p>
</p>
<h2><a name="new">new</a></h2>
<p>To use any of the utility methods, you must create a utility object:</p>
<pre>
  use Mail::Toaster::Utility;
  my $utility = Mail::Toaster::Utility-&gt;new;</pre>
<p>
</p>
<h2><a name="answer">answer</a></h2>
<pre>
  my $answer = $utility-&gt;answer(&quot;question&quot;, $default, $timer)</pre>
<p>arguments:
 a string with the question to ask
 an optional default answer.
 how long (in seconds) to wait for a response</p>
<p>returned is a string. If the user responded, their response is returned. If not, then the default response is returned. If no default was supplied, 0 is returned.</p>
<p>
</p>
<h2><a name="archive_expand">archive_expand</a></h2>
<pre>
  $utility-&gt;archive_expand(&quot;package.tar.bz2&quot;, $debug);</pre>
<p>Takes an archive and decompresses and expands it's contents. Works with bz2, gz, and tgz files.</p>
<p>
</p>
<h2><a name="chdir_source_dir">chdir_source_dir</a></h2>
<pre>
  $utility-&gt;chdir_source_dir(&quot;/usr/local/src&quot;);</pre>
<p>changes your working directory to the supplied one. Creates it if it doesn't exist.</p>
<p>returns 1 on success</p>
<p>
</p>
<h2><a name="check_homedir_ownership">check_homedir_ownership</a></h2>
<p>Checks the ownership on all home directories to see if they are owned by their respective users in /etc/password. Offers to repair the permissions on incorrectly owned directories. This is useful when someone that knows better does something like ``chown -R user /home /user'' and fouls things up.</p>
<pre>
  $utility-&gt;check_homedir_ownership;</pre>
<p>
</p>
<h2><a name="clean_tmp_dir">clean_tmp_dir</a></h2>
<pre>
  $utility-&gt;clean_tmp_dir($dir)</pre>
<p>$dir is a directory. Running this will empty it. Be careful!</p>
<p>
</p>
<h2><a name="drives_get_mounted">drives_get_mounted</a></h2>
<pre>
  $utility-&gt;drives_get_mounted($debug);</pre>
<p>Uses mount to fetch a list of mounted drive/partitions.</p>
<p>returned is a hashref of mounted slices and their mount points.</p>
<p>
</p>
<h2><a name="install_from_sources_php">install_from_sources_php</a></h2>
<pre>
  $utility-&gt;install_from_sources_php();</pre>
<p>Downloads a PHP program and installs it. Not completed.</p>
<p>
</p>
<h2><a name="file_append">file_append</a></h2>
<pre>
  $utility-&gt;file_append($file, $lines)</pre>
<p>Pass a filename and an array ref and it'll append the array contents to the file. It's that simple.</p>
<p>
</p>
<h2><a name="file_archive">file_archive</a></h2>
<pre>
  $utility-&gt;file_archive ($file)</pre>
<p>Make a backup copy of a file by copying the file to $file.timestamp.</p>
<p>returns 0 on failure, a file path on success.</p>
<p>
</p>
<h2><a name="file_check_readable">file_check_readable</a></h2>
<pre>
  $utility-&gt;file_check_readable($file);</pre>
<p>input is a string consisting of a path name to a file. An optional second argument changes the default exit behaviour to warn and continue (rather than dying).</p>
<p>return is 1 for yes, 0 for no.</p>
<p>
</p>
<h2><a name="file_check_writable">file_check_writable</a></h2>
<pre>
   use Mail::Toaster::Utility;
   $utility-&gt;file_check_writable(&quot;/tmp/boogers&quot;, $debug) ? print &quot;yes&quot; : print &quot;no&quot;;</pre>
<p>If the file exists, it checks to see if it's writable. If the file does not exist, then it checks to see if the enclosing directory is writable.</p>
<p>It will output verbose messages if you set the debug flag.</p>
<p>returns a 1 if writable, zero otherwise.</p>
<p>
</p>
<h2><a name="file_delete">file_delete</a></h2>
<p>Deletes a file. Uses unlink if we have appropriate permissions, otherwise uses a system rm call, using sudo if it's not being run as root. This sub will try very hard to delete the file!</p>
<pre>
   $utility-&gt;file_delete($file, $warn);</pre>
<p>Arguments are a file path and $warn is an optional boolean.</p>
<p>returns 1 for success, 0 for failure.</p>
<p>
</p>
<h2><a name="file_get">file_get</a></h2>
<pre>
   $utility-&gt;file_get($url, $debug);</pre>
<p>Use an appropriate URL fetching utility (fetch, curl, wget, etc) based on your OS to download a file from the $url handed to us.</p>
<p>Returns 1 for success, 0 for failure.</p>
<p>
</p>
<h2><a name="file_read">file_read</a></h2>
<pre>
   my @lines = $utility-&gt;file_read($file)</pre>
<p>Reads in a file, and returns an array with the files contents, one line per array element. All lines in array are chomped.</p>
<p>
</p>
<h2><a name="file_write">file_write</a></h2>
<pre>
   $utility-&gt;file_write ($file, @lines)</pre>
<pre>
        my $file = &quot;/tmp/foo&quot;;
        my @lines = &quot;1&quot;, &quot;2&quot;, &quot;3&quot;;</pre>
<pre>
        print &quot;success&quot; if ($utility-&gt;file_write($file, @lines));</pre>
<p>$file is the file you want to write to
@lines is a an array, each array element is a line in the file</p>
<p>1 is returned on success, 0 or undef on failure</p>
<p>
</p>
<h2><a name="files_diff">files_diff</a></h2>
<pre>
   $utility-&gt;files_diff($file1, $file2, $type, $debug);</pre>
<pre>
   if ( $utility-&gt;files_diff(&quot;foo&quot;, &quot;bar&quot;) ) 
   { 
       print &quot;different!\n&quot;; 
   };</pre>
<p>Determine if the files are different. $type is assumed to be text unless you set it otherwise. For anthing but text files, we do a MD5 checksum on the files to determine if they're different or not.</p>
<p>return 0 if files are the same, 1 if they are different, and -1 on error.</p>
<p>
</p>
<h2><a name="find_the_bin">find_the_bin</a></h2>
<pre>
   $utility-&gt;find_the_bin($bin, $dir);</pre>
<p>Check all the ``normal'' locations for a binary that should be on the system and returns the full path to the binary. Return zero if we can't find it.</p>
<p>If the optional $dir is sent, then check that directory first.</p>
<p>Example:</p>
<pre>
   my $apachectl = $utility-&gt;find_the_bin(&quot;apachectl&quot;, &quot;/usr/local/sbin&quot;)</pre>
<p>
</p>
<h2><a name="fstab_list">fstab_list</a></h2>
<p>Fetch a list of drives that are mountable from /etc/fstab.</p>
<pre>
   $utility-&gt;fstab_list;</pre>
<p>returns an arrayref.</p>
<p>
</p>
<h2><a name="get_dir_files">get_dir_files</a></h2>
<pre>
   $utility-&gt;get_dir_files($dir, $debug)</pre>
<p>$dir is a directory. The return will be an array of files names contained in that directory.</p>
<p>
</p>
<h2><a name="get_the_date">get_the_date</a></h2>
<pre>
   $utility-&gt;get_the_date ($bump, $debug)</pre>
<p>$bump is the optional offset (in seconds) to subtract from the date.</p>
<p>returned is an array:</p>
<pre>
        $dd = day
        $mm = month
        $yy = year
        $lm = last month
        $hh = hours
        $mn = minutes
        $ss = seconds</pre>
<pre>
        my ($dd, $mm, $yy, $lm, $hh, $mn, $ss) = $utility-&gt;get_the_date();</pre>
<p>
</p>
<h2><a name="install_from_source">install_from_source</a></h2>
<pre>
   $vals = { package =&gt; 'simscan-1.07',
           site    =&gt; '<a href="http://www.inter7.com">http://www.inter7.com</a>',
           url     =&gt; '/simscan/',
           targets =&gt; ['./configure', 'make', 'make install'],
           patches =&gt; '',
           debug   =&gt; 1,
   };</pre>
<pre>
        $utility-&gt;install_from_source($conf, $vals, $debug);</pre>
<p>Downloads and installs a program from sources.</p>
<p>targets and partches are array references.</p>
<p>An optional value to set is bintest. If set, it'll check the usual places for an executable binary. If found, it'll assume the software is already installed and require confirmation before re-installing.</p>
<p>returns 1 on success, 0 on failure.</p>
<p>
</p>
<h2><a name="is_arrayref">is_arrayref</a></h2>
<p>Checks whatever object is passed to it to see if it's an arrayref.</p>
<pre>
   $utility-&gt;is_arrayref($testme, $debug);</pre>
<p>Enable debugging to see helpful error messages.</p>
<p>
</p>
<h2><a name="is_hashref">is_hashref</a></h2>
<p>Most methods pass parameters around inside hashrefs. Unfortunately, if you try accessing a hashref method and the object isn't a hashref, it generates a fatal exception. This traps that exception and prints a useful error message.</p>
<pre>
   $utility-&gt;is_hashref($hashref, $debug);</pre>
<p>
</p>
<h2><a name="is_process_running">is_process_running</a></h2>
<p>Verify if a process is running or not.</p>
<pre>
   $utility-&gt;is_process_running($process) ? print &quot;yes&quot; : print &quot;no&quot;;</pre>
<p>$process is the name as it would appear in the process table.</p>
<p>
</p>
<h2><a name="logfile_append">logfile_append</a></h2>
<pre>
   $utility-&gt;logfile_append($file, \@lines)</pre>
<p>Pass a filename and an array ref and it'll append a timestamp and the array contents to the file. Here's a working example:</p>
<pre>
   $utility-&gt;logfile_append($file, [&quot;proggy&quot;, &quot;Starting up&quot;, &quot;Shutting down&quot;] )</pre>
<p>That will append a line like this to the log file:</p>
<pre>
   2004-11-12 23:20:06 proggy Starting up
   2004-11-12 23:20:06 proggy Shutting down</pre>
<p>
</p>
<h2><a name="mailtoaster">mailtoaster</a></h2>
<pre>
   $utility-&gt;mailtoaster();</pre>
<p>Downloads and installs Mail::Toaster.</p>
<p>
</p>
<h2><a name="path_parse">path_parse</a></h2>
<pre>
   my ($up1dir, $userdir) = $utility-&gt;path_parse($dir)</pre>
<p>Takes a path like ``/usr/home/matt'' and returns ``/usr/home'' and ``matt''</p>
<p>You (and I) should be using File::Basename instead as it's more portable.</p>
<p>
</p>
<h2><a name="parse_config">parse_config</a></h2>
<pre>
   $hashref = {
      file   =&gt; $file,    # file to be parsed
      debug  =&gt; $debug,   # 
      etcdir =&gt; $etcdir,  # where should I find $file?
   };</pre>
<pre>
   $conf = $utility-&gt;parse_config( $hashref );</pre>
<p>pass parse_config a hashref. $etcdir defaults to /usr/local/etc and will also checks the current working directory.</p>
<p>A hashref is returned with the key/value pairs.</p>
<p>
</p>
<h2><a name="pidfile_check">pidfile_check</a></h2>
<p>pidfile_check is a process management method. It will check to make sure an existing pidfile does not exist and if not, it will create the pidfile.</p>
<pre>
   $pidfile = $utility-&gt;pidfile_check(&quot;/var/run/program.pid&quot;);</pre>
<p>The above example is all you need to do to add process checking (avoiding multiple daemons running at the same time) to a program or script. This is used in toaster-watcher.pl and rrdutil. toaster-watcher normally completes a run in a few seconds and is run every 5 minutes.</p>
<p>However, toaster-watcher can be configured to do things like expire old messages from maildirs and feed spam through a processor like sa-learn. This can take a long time on a large mail system so we don't want multiple instances of toaster-watcher running.</p>
<p>returns the path to the pidfile (on success).</p>
<p>Example:</p>
<pre>
        my $pidfile = $utility-&gt;pidfile_check(&quot;/var/run/changeme.pid&quot;);
        unless ($pidfile) {
                warn &quot;WARNING: couldn't create a process id file!: $!\n&quot;;
                exit 0;
        };</pre>
<pre>
        do_a_bunch_of_cool_stuff;
        unlink $pidfile;</pre>
<p>
</p>
<h2><a name="source_warning">source_warning</a></h2>
<p>Just check to see if the sources are present. If they are, offer to remove them.</p>
<pre>
   $utility-&gt;source_warning(&quot;Mail-Toaster-4.01&quot;, 1, &quot;/usr/local/etc&quot;);</pre>
<p>returns 1 if removed.</p>
<p>Example:</p>
<pre>
   unless ( $utility-&gt;source_warning($package, 1, $src) )
   { 
      carp &quot;OK then, skipping install.\n&quot;;
      exit 0;
   };</pre>
<p>
</p>
<h2><a name="sudo">sudo</a></h2>
<pre>
   my $sudo = $utility-&gt;sudo();</pre>
<pre>
        $utility-&gt;syscmd(&quot;$sudo rm /etc/root-owned-file&quot;);</pre>
<p>Often you want to run a script as an unprivileged user. However, the script may need elevated privileges for a plethora of reasons. Rather than running the script suid, or as root, configure sudo allowing the script to run system commands with appropriate permissions.</p>
<p>If sudo is not installed and you're running as root, it'll offer to install sudo for you. This is recommended, as is properly configuring sudo.</p>
<p>
</p>
<h2><a name="syscmd">syscmd</a></h2>
<p>Just a little wrapper around system calls, that returns any failure codes and prints out the <code>error(s)</code> if present.</p>
<pre>
   my $r = $utility-&gt;syscmd($cmd);
   $r ? print &quot;not ok!\n&quot; : print &quot;ok.\n&quot;;</pre>
<p>return is the exit status of the program you called.</p>
<p>
</p>
<h2><a name="yes_or_no">yes_or_no</a></h2>
<pre>
   my $r = $utility-&gt;yes_or_no(&quot;Would you like fries with that?&quot;);</pre>
<pre>
        $r ? print &quot;fries are in the bag\n&quot; : print &quot;no fries!\n&quot;;</pre>
<p>There are two optional arguments that can be passed. The first is a string which is the question to ask. The second is an integer representing how long (in seconds) to wait before timing out.</p>
<p>returns 1 on yes, 0 on negative or null response.</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Matt Simerson &lt;<a href="mailto:matt@cadillac.net">matt@cadillac.net</a>&gt;</p>
<p>
</p>
<hr />
<h1><a name="bugs">BUGS</a></h1>
<p>None known. Report any to author.</p>
<p>
</p>
<hr />
<h1><a name="todo">TODO</a></h1>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>The following are all man/perldoc pages:</p>
<pre>
 Mail::Toaster 
 Mail::Toaster::Apache 
 Mail::Toaster::CGI  
 Mail::Toaster::DNS 
 Mail::Toaster::Darwin
 Mail::Toaster::Ezmlm
 Mail::Toaster::FreeBSD
 Mail::Toaster::Logs 
 Mail::Toaster::Mysql
 Mail::Toaster::Passwd
 Mail::Toaster::Perl
 Mail::Toaster::Provision
 Mail::Toaster::Qmail
 Mail::Toaster::Setup
 Mail::Toaster::Utility</pre>
<pre>
 Mail::Toaster::Conf
 toaster.conf
 toaster-watcher.conf</pre>
<pre>
 <a href="http://matt.simerson.net/computing/mail/toaster/">http://matt.simerson.net/computing/mail/toaster/</a>
 <a href="http://matt.simerson.net/computing/mail/toaster/docs/">http://matt.simerson.net/computing/mail/toaster/docs/</a></pre>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>Copyright 2003-2005, The Network People, Inc. All Rights Reserved.</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</p>
<p>Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</p>
<p>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</p>
<p>Neither the name of the The Network People, Inc. nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</p>
<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>

</body>

</html>
