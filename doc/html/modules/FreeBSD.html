<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Mail::Toaster::FreeBSD</title>
<link rev="made" href="mailto:root@hampsten.nonet" />
</head>

<body style="background-color: white">

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#methods">METHODS</a></li>
	<ul>

		<li><a href="#new">new</a></li>
		<li><a href="#jail_delete">jail_delete</a></li>
		<li><a href="#jail_start">jail_start</a></li>
		<li><a href="#rc_dot_conf_check">rc_dot_conf_check</a></li>
		<li><a href="#jail_create">jail_create</a></li>
		<li><a href="#source_update">source_update</a></li>
		<li><a href="#ports_update">ports_update</a></li>
		<li><a href="#port_install">port_install</a></li>
		<li><a href="#ports_check_age">ports_check_age</a></li>
		<li><a href="#package_install">package_install</a></li>
		<li><a href="#is_port_installed">is_port_installed</a></li>
	</ul>

	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#bugs">BUGS</a></li>
	<li><a href="#todo">TODO</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
</ul>
<!-- INDEX END -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Mail::Toaster::FreeBSD</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>FreeBSD scripting functions</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>a group of frequently used functions for perl scripts running on FreeBSD systems.</p>
<p>Usage examples for each subroutine are included.</p>
<p>
</p>
<hr />
<h1><a name="methods">METHODS</a></h1>
<p>
</p>
<h2><a name="new">new</a></h2>
<pre>
        use Mail::Toaster::FreeBSD;
        my $fbsd = Mail::Toaster::FreeBSD-&gt;new;</pre>
<p>
</p>
<h2><a name="jail_delete">jail_delete</a></h2>
<p>Delete a jail.</p>
<pre>
  $freebsd-&gt;jail_delete( {ip=&gt;'10.0.1.160'} );</pre>
<p>This script unmounts the proc and dev filesystems and then nukes the jail directory.</p>
<p>It would be a good idea to shut down any processes in the jail first.</p>
<p>
</p>
<h2><a name="jail_start">jail_start</a></h2>
<p>Starts up a FreeBSD jail.</p>
<pre>
        $fbsd-&gt;jail_start($input);</pre>
<p>$input is a hashref as follows:</p>
<pre>
    input = { 
        ip        =&gt; 10.0.1.1,
        hostname  =&gt; jail36.example.com,
        jail_home =&gt; /home/jail,
        debug     =&gt; 1
    };</pre>
<p>hostname is optional, If not passed and reverse DNS is set up, it will
looked up. Otherwise, the hostname defaults to ``jail''.</p>
<p>jail_home is optional, it defaults to ``/home/jail''.</p>
<p>Here's an example of how I use it:</p>
<pre>
    perl -e 'use Mail::Toaster::FreeBSD; 
      my $fbsd = new Mail::Toaster::FreeBSD; 
      $fbsd-&gt;jail_start( {ip=&gt;&quot;10.0.1.175&quot;})';</pre>
<p>
</p>
<h2><a name="rc_dot_conf_check">rc_dot_conf_check</a></h2>
<pre>
    $fbsd-&gt;rc_dot_conf_check(&quot;snmpd_enable&quot;, &quot;snmpd_enable=\&quot;YES\&quot;&quot;);</pre>
<p>The above example is for snmpd. This checks to verify that an snmpd_enable line exists in /etc/rc.conf. If it doesn't, then it will add it by appending the second argument to the file.</p>
<p>
</p>
<h2><a name="jail_create">jail_create</a></h2>
<pre>
    $fbsd-&gt;jail_create($input);</pre>
<p>$input is a hashref as follows:</p>
<pre>
    input = { 
        ip        =&gt; 10.0.1.1,
        hostname  =&gt; jail36.example.com,
        jail_home =&gt; /home/jail,
        debug     =&gt; 1
    };</pre>
<p>hostname is optional, If not passed and reverse DNS is set up, it will
looked up. Otherwise, the hostname defaults to ``jail''.</p>
<p>jail_home is optional, it defaults to ``/home/jail''.</p>
<p>Here's an example of how I use it:</p>
<pre>
    ifconfig fxp0 inet alias 10.0.1.175/32</pre>
<pre>
    perl -e 'use Mail::Toaster::FreeBSD;  
         my $fbsd = new Mail::Toaster::FreeBSD; 
         $fbsd-&gt;jail_create( {ip=&gt;&quot;10.0.1.175&quot;} )';</pre>
<p>After running $bsd-&gt;jail_create, you need to set up the jail. 
At the very least, you need to:</p>
<pre>
    1. set root password
    2. create a user account
    3. get remote root 
        a) use sudo (pkg_add -r sudo; visudo)
        b) add user to wheel group (vi /etc/group)
        c) modify /etc/ssh/sshd_config to permit root login
    4. install perl (pkg_add -r perl)</pre>
<p>Here's how I set up my jails:</p>
<pre>
    pw useradd -n matt -d /home/matt -s /bin/tcsh -m -h 0
    passwd root
    pkg_add -r sudo rsync
    rehash; visudo
    pkg_add -r perl5.8
    sh /etc/rc</pre>
<p>Ssh into the jail from another terminal. Once successfully 
logged in with root privs, you can drop the initial shell 
and access the jail directly.</p>
<p>Read the jail man pages for more details. Read the perl code
to see what else it does.</p>
<p>
</p>
<h2><a name="source_update">source_update</a></h2>
<p>Updates the FreeBSD sources (/usr/src/*) in preparation for building a fresh FreeBSD world.</p>
<pre>
    $fbsd-&gt;source_update($conf);</pre>
<p>$conf is a hashref. Optional settings to be passed are:</p>
<pre>
  $conf = {
      cvsup_server_preferred =&gt; 'fastest',
      cvsup_server_country   =&gt; 'us',
      toaster_dl_site        =&gt; '<a href="http://www.tnpi.biz">http://www.tnpi.biz</a>',
      toaster_dl_url         =&gt; '/internet/mail/toaster/',
      cvsup_supfile_sources  =&gt; '/etc/cvsup-stable',
   };</pre>
<p>See the docs for toaster-watcher.conf for complete details.</p>
<p>
</p>
<h2><a name="ports_update">ports_update</a></h2>
<p>Updates the FreeBSD ports tree (/usr/ports/*).</p>
<pre>
    $fbsd-&gt;ports_update($conf);</pre>
<p>$conf is a hashref. Optional settings to be passed are:</p>
<pre>
   cvsup_server_preferred
   cvsup_server_country
   toaster_dl_site
   toaster_dl_url</pre>
<p>See the docs for toaster-watcher.conf for complete details.</p>
<p>
</p>
<h2><a name="port_install">port_install</a></h2>
<pre>
    $fbsd-&gt;port_install(&quot;openldap2&quot;, &quot;net&quot;);</pre>
<p>That's it. Really. Well, OK, sometimes it can get a little more complex. port_install checks first to determine if a port is already installed and if so, skips right on by. It's very intelligent that way. However, sometimes port maintainers do goofy things and we need to override the directory directory we install from. A good example of this is currently openldap2.</p>
<p>If you want to install OpenLDAP 2, then you can install from any of:</p>
<pre>
                /usr/ports/net/openldap2
                /usr/ports/net/openldap20
                /usr/ports/net/openldap21
                /usr/ports/net/openldap22</pre>
<p>BTW: The second argument (``net'') is what determines where in FreeBSD's ports tree the script can find OpenLDAP. If you pass along a third argument, we'll use it instead of the port name as the port directory to install from.</p>
<p>On rare occasion, a port will get installed as a name other than the ports name. Of course, that wreaks all sorts of havoc so when one of them nasties is found, you can optionally pass along a fourth parameter which can be used as the port installation name to check with.</p>
<p>On yet other occassions, you'll want to pass make flags to the port. The fifth argument can be a comma separated list of make arguments.</p>
<p>The sixth optional flag is whether errors should be fatal or not. Binary values.</p>
<p>And the seventh is debugging. Setting will increase the amount of logging.</p>
<p>So, a full complement of settings could look like:</p>
<pre>
  
    $fbsd-&gt;port_install(&quot;openldap2&quot;, &quot;net&quot;, &quot;openldap22&quot;, &quot;openldap-2.2&quot;, &quot;NOPORTDOCS&quot;, 0, 1);</pre>
<p>
</p>
<h2><a name="ports_check_age">ports_check_age</a></h2>
<p>Checks how long it's been since you've updated your ports tree. Since the ports tree can be a roaming target, by making sure it's current before installing ports we can increase the liklihood of success.</p>
<pre>
        $fbsd-&gt;ports_check_age(&quot;20&quot;);</pre>
<p>That'll update the ports tree if it's been more than 20 days since it was last updated.</p>
<p>You can optionally pass along a URL as the second argument from where to fetch the cvsup-ports file. If you have a custom one for your site, pass along the URL (minus the file name).</p>
<p>
</p>
<h2><a name="package_install">package_install</a></h2>
<pre>
        $fbsd-&gt;package_install(&quot;ispell&quot;);</pre>
<p>Suggested usage:</p>
<pre>
        unless ( $fbsd-&gt;package_install(&quot;ispell&quot;) ) {
                $fbsd-&gt;port_install(&quot;ispell&quot;, &quot;textproc&quot;);
        };</pre>
<p>Installs the selected package from FreeBSD packages. If the first install fails, it'll try again using an alternate FTP site (ftp2.freebsd.org). If that fails, it returns 0 (failure) so you know it failed and can try something else, like installing via ports.</p>
<p>If the package is registered in FreeBSD's package registry as another name and you want to check against that name (so it doesn't try installing a package that's already installed), instead, pass it along as the second argument.</p>
<p>If you want to retrieve packages from a package site other than FreeBSD's (the default), then pass along that URL as the third argument. See the pkg_add man page for more details.</p>
<p>
</p>
<h2><a name="is_port_installed">is_port_installed</a></h2>
<p>Checks to see if a port is installed.</p>
<pre>
    $fbsd-&gt;is_port_installed(&quot;p5-CGI&quot;);</pre>
<p>Input is two strings, first is the package name, second is an alternate package name. This is necessary as some ports evolve and register themselves differently in the ports database.</p>
<p>returns 1 if installed, 0 if not</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Matt Simerson &lt;<a href="mailto:matt@tnpi.biz">matt@tnpi.biz</a>&gt;</p>
<p>
</p>
<hr />
<h1><a name="bugs">BUGS</a></h1>
<p>None known. Report any to author.</p>
<p>
</p>
<hr />
<h1><a name="todo">TODO</a></h1>
<p>Needs more documentation.</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Mail::Toaster, Mail::Toaster::FreeBSD</p>
<pre>
        <a href="http://www.tnpi.biz/computing/freebsd/">http://www.tnpi.biz/computing/freebsd/</a>
        <a href="http://www.tnpi.biz/internet/">http://www.tnpi.biz/internet/</a>
        <a href="http://www.tnpi.biz/internet/mail/toaster">http://www.tnpi.biz/internet/mail/toaster</a></pre>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>Copyright 2003-2004, The Network People, Inc. All Rights Reserved.</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</p>
<p>Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</p>
<p>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</p>
<p>Neither the name of the The Network People, Inc. nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</p>
<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>

</body>

</html>
